import LoadingSpinner from '@/components/common/LoadingSpinner';
import { FiRefreshCw, FiFileText, FiChevronDown, FiChevronRight, FiArrowLeft, FiBookOpen } from 'react-icons/fi';

import React, { useMemo, useState } from 'react';
import { useTaxData } from '@/hooks/useTaxData';
import { TaxService } from '@/services/taxService';
import toast from 'react-hot-toast';
import Tooltip from './Tooltip';

interface TaxRateRow {
  ë‚©ì„¸ì: string;
  ì·¨ë“ì›ì¸: string;
  ê±°ë˜ìœ í˜•: string;
  ë¬¼ê±´: string;
  ë¬¼ê±´_description?: string;
  ì§€ì—­: string;
  ì£¼íƒìˆ˜: string;
  ê°€ê²©ëŒ€: string;
  ë©´ì : string;
  ì·¨ë“ì„¸: string;
  ì§€ë°©êµìœ¡ì„¸: string;
  ë†íŠ¹ì„¸: string;
  í•©ê³„: string;
  ë¹„ê³ : string;
  legal_basis?: string[];
  ì·¨ë“ì„¸_legal_basis?: string[];
  ì§€ë°©êµìœ¡ì„¸_legal_basis?: string[];
  ë†íŠ¹ì„¸_legal_basis?: string[];
  subRows?: TaxRateRow[];
}

interface FilterState {
  ë‚©ì„¸ì: string;
  ì·¨ë“ì›ì¸: string;
  ê±°ë˜ìœ í˜•: string;
  ë¬¼ê±´: string;
  ì§€ì—­êµ¬ë¶„?: string;
  ì£¼íƒìˆ˜?: string;
}

// ì·¨ë“ì„¸ìœ¨ ì¼€ì´ìŠ¤ ë°ì´í„° êµ¬ì¡°
interface TaxCaseData {
  case: string;
  case_code: string;
  effective_date: string;
  section: any[];
}

// í•„í„° ì˜µì…˜ ìƒìˆ˜ ì •ì˜
const FILTER_OPTIONS = {
  ë‚©ì„¸ì: ['ê°œì¸', 'ë²•ì¸',  'ë¹„ì˜ë¦¬ì‚¬ì—…ì'],
  ì·¨ë“ì›ì¸: ['ìœ ìƒ', 'ë¬´ìƒ', 'ì›ì‹œ', 'ì˜ì œ'],
  ê±°ë˜ìœ í˜•: ['ë§¤ë§¤', 'êµí™˜', 'ìƒì†', 'ì¦ì—¬', 'ì‹ ì¶•', 'ê³¼ì ì£¼ì£¼'],
  ë¬¼ê±´: ['ì£¼íƒ', 'ë†ì§€', 'ë†ì§€ì™¸', 'ê³¨í”„ì¥', 'ê³ ê¸‰ì˜¤ë½ì¥', 'ê³ ê¸‰ì£¼íƒ'],
  ì§€ì—­êµ¬ë¶„: [
    { label: 'ì¡°ì •ëŒ€ìƒì§€ì—­', value: 'ì¡°ì •' },
    { label: 'ë¹„ì¡°ì •ëŒ€ìƒì§€ì—­', value: 'ë¹„ì¡°ì •' }
  ],
  ì£¼íƒìˆ˜: ['1ì£¼íƒ', '2ì£¼íƒ', '3ì£¼íƒ', '4ì£¼íƒ ì´ìƒ']
};

const AcquisitionRates: React.FC = () => {
  const { data: taxData, isLoading, error } = useTaxData();

  // ì¼€ì´ìŠ¤ë³„ ë°ì´í„° ìƒíƒœ
  const [selectedCase, setSelectedCase] = useState<TaxCaseData | null>(null);

  // í•„í„° ìƒíƒœ ê´€ë¦¬
  const [filters, setFilters] = useState<FilterState>({
    ë‚©ì„¸ì: '',
    ì·¨ë“ì›ì¸: '',
    ê±°ë˜ìœ í˜•: '',
    ë¬¼ê±´: '',
    ì£¼íƒìˆ˜: '',
    ì§€ì—­êµ¬ë¶„: ''
  });

  // ì¼€ì´ìŠ¤ ëª©ë¡ ë°ì´í„° ì¶”ì¶œ
  const casesList = useMemo(() => {
    if (!taxData || !Array.isArray(taxData)) return [];
    console.log("==========ì „ì²´ taxData ê°œìˆ˜:", taxData.length);
    // ì›ë³¸ ë°ì´í„°ì—ì„œ ì¼€ì´ìŠ¤ë³„ë¡œ ê·¸ë£¹í™”
    const cases: TaxCaseData[] = [];

    taxData.forEach((section: any) => {
      console.log("ğŸ“Œ section.title:", section.title, "| originalCase:", section.originalCase);
      if (section.originalCase) {
        // ê°™ì€ ì¼€ì´ìŠ¤ê°€ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
        let existingCase = cases.find(c => c.case === section.originalCase);

        if (!existingCase) {
          // ìƒˆë¡œìš´ ì¼€ì´ìŠ¤ ìƒì„±
          existingCase = {
            case: section.originalCase,
            case_code: section.originalCase.replace(/\s+/g, '_').toLowerCase(),
            effective_date: '2025-09-21',
            section: []
          };
          cases.push(existingCase);
        }

        // ì„¹ì…˜ ì¶”ê°€
        existingCase.section.push(section);
      }
    });

    return cases;
  }, [taxData]);

  // í•„í„° ë¦¬ì…‹ í•¨ìˆ˜
  const resetFilters = () => {
    setFilters({
      ë‚©ì„¸ì: '',
      ì·¨ë“ì›ì¸: '',
      ê±°ë˜ìœ í˜•: '',
      ë¬¼ê±´: '',
      ì§€ì—­êµ¬ë¶„: '',
      ì£¼íƒìˆ˜: ''
    });
  };

  // í•„í„° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  const updateFilter = (key: keyof FilterState, value: string) => {
    setFilters(prev => {
      const newFilters = {
        ...prev,
        [key]: prev[key] === value ? '' : value // ê°™ì€ ë²„íŠ¼ í´ë¦­ì‹œ í† ê¸€
      };

      // ë¬¼ê±´ì´ ì£¼íƒì´ ì•„ë‹ˆë©´ ì§€ì—­êµ¬ë¶„ê³¼ ì£¼íƒìˆ˜ ì´ˆê¸°í™”
      if (key === 'ë¬¼ê±´' && value !== 'ì£¼íƒ') {
        newFilters.ì§€ì—­êµ¬ë¶„ = '';
        newFilters.ì£¼íƒìˆ˜ = '';
      }

      // ë¬¼ê±´ì´ ë¹„ì–´ìˆìœ¼ë©´ ì§€ì—­êµ¬ë¶„ê³¼ ì£¼íƒìˆ˜ ì´ˆê¸°í™”
      if (key === 'ë¬¼ê±´' && prev[key] === value) {
        newFilters.ì§€ì—­êµ¬ë¶„ = '';
        newFilters.ì£¼íƒìˆ˜ = '';
      }

      return newFilters;
    });
  };

  // ì¼€ì´ìŠ¤ ì„ íƒ í•¸ë“¤ëŸ¬
  const handleCaseSelect = (caseData: TaxCaseData) => {
    setSelectedCase(caseData);
  };

  // ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
  const handleBackToList = () => {
    setSelectedCase(null);
  };

  // ë°ì´í„°ë¥¼ í‘œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
  const tableData = useMemo(() => {
    if (!selectedCase) return [];

    const rows: TaxRateRow[] = [];
    const addedRows = new Set<string>(); // ì¤‘ë³µ ì²´í¬ìš©

    // ì„¸ìœ¨ ë°ì´í„° ì¶”ì¶œ
    const extractTaxRates = (details: any[], parentLegalBasisData?: any[], centralLegalBasis?: any[]) => {
      const rates = {
        ì·¨ë“ì„¸: '',
        ì§€ë°©êµìœ¡ì„¸: '',
        ë†íŠ¹ì„¸: '',
        í•©ê³„: '',
        ì·¨ë“ì„¸_legal_basis: [] as string[],
        ì§€ë°©êµìœ¡ì„¸_legal_basis: [] as string[],
        ë†íŠ¹ì„¸_legal_basis: [] as string[]
      };

      details.forEach((detail: any) => {
        if (detail.title === 'ì·¨ë“ì„¸') {
          rates.ì·¨ë“ì„¸ = detail.content;
          if (detail.legal_basis && detail.legal_basis !== '') {
            const legalDataToUse = centralLegalBasis || parentLegalBasisData;
            if (legalDataToUse) {
              const basisInfo = TaxService.parseLegalBasisInfo(legalDataToUse, detail.legal_basis);
              rates.ì·¨ë“ì„¸_legal_basis = basisInfo || [];
            } else if (Array.isArray(detail.legal_basis)) {
              rates.ì·¨ë“ì„¸_legal_basis = detail.legal_basis;
            }
          }
        } else if (detail.title === 'ì§€ë°©êµìœ¡ì„¸') {
          rates.ì§€ë°©êµìœ¡ì„¸ = detail.content;
          if (detail.legal_basis && detail.legal_basis !== '') {
            const legalDataToUse = centralLegalBasis || parentLegalBasisData;
            if (legalDataToUse) {
              const basisInfo = TaxService.parseLegalBasisInfo(legalDataToUse, detail.legal_basis);
              rates.ì§€ë°©êµìœ¡ì„¸_legal_basis = basisInfo || [];
            } else if (Array.isArray(detail.legal_basis)) {
              rates.ì§€ë°©êµìœ¡ì„¸_legal_basis = detail.legal_basis;
            }
          }
        } else if (detail.title === 'ë†íŠ¹ì„¸') {
          rates.ë†íŠ¹ì„¸ = detail.content;
          if (detail.legal_basis && detail.legal_basis !== '') {
            const legalDataToUse = centralLegalBasis || parentLegalBasisData;
            if (legalDataToUse) {
              const basisInfo = TaxService.parseLegalBasisInfo(legalDataToUse, detail.legal_basis);
              rates.ë†íŠ¹ì„¸_legal_basis = basisInfo || [];
            } else if (Array.isArray(detail.legal_basis)) {
              rates.ë†íŠ¹ì„¸_legal_basis = detail.legal_basis;
            }
          }
        } else if (detail.title === 'í•©ê³„') {
          rates.í•©ê³„ = detail.content;
        }
      });

      return rates;
    };

    // ì¬ê·€ì ìœ¼ë¡œ ë°ì´í„° êµ¬ì¡°ë¥¼ íŒŒì‹±í•˜ëŠ” í•¨ìˆ˜
    const parseDataRecursively = (data: any, context: any = {}, depth: number = 0) => {
      const currentContext = { ...context };

      // console.log(`${'  '.repeat(depth)}ğŸ” parseData í˜¸ì¶œ: ${data.title}, ì§€ì—­=${context.ì§€ì—­}`);

      // ì»¨í…ìŠ¤íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
      if (data.title && (data.title.includes('6ì–µì›') || data.title === '9ì–µì› ì´ˆê³¼')) {
        currentContext.ê°€ê²©ëŒ€ = data.title;
        // console.log(`${'  '.repeat(depth)}  ğŸ’° ê°€ê²©ëŒ€ ì„¤ì •: ${data.title}`);
      } else if (data.title && data.title.includes('ã¡')) {
        currentContext.ë©´ì  = data.title;
        // console.log(`${'  '.repeat(depth)}  ğŸ“ ë©´ì  ì„¤ì •: ${data.title}`);
      }

      // ì„¸ìœ¨ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
      if (Array.isArray(data.content) && data.content.some((d: any) => d.title === 'ì·¨ë“ì„¸')) {
        console.log(`${'  '.repeat(depth)}  âœ¨ ì„¸ìœ¨ ë°œê²¬! ì§€ì—­=${currentContext.ì§€ì—­}`);
        const rates = extractTaxRates(data.content, currentContext.originalLegalBasis, currentContext.centralLegalBasis);
        const newRow = {
          ë‚©ì„¸ì: currentContext.ë‚©ì„¸ì || '',
          ì·¨ë“ì›ì¸: currentContext.ì·¨ë“ì›ì¸ || '',
          ê±°ë˜ìœ í˜•: currentContext.ê±°ë˜ìœ í˜• || '',
          ë¬¼ê±´: currentContext.ë¬¼ê±´ || '',
          ë¬¼ê±´_description: currentContext.ë¬¼ê±´_description || '',
          ì§€ì—­: currentContext.ì§€ì—­ || '',
          ì£¼íƒìˆ˜: currentContext.ì£¼íƒìˆ˜ || '',
          ê°€ê²©ëŒ€: currentContext.ê°€ê²©ëŒ€ || '',
          ë©´ì : currentContext.ë©´ì  || '',
          ì·¨ë“ì„¸: rates.ì·¨ë“ì„¸,
          ì§€ë°©êµìœ¡ì„¸: rates.ì§€ë°©êµìœ¡ì„¸,
          ë†íŠ¹ì„¸: rates.ë†íŠ¹ì„¸,
          í•©ê³„: rates.í•©ê³„,
          ë¹„ê³ : data.description || '',
          legal_basis: Array.isArray(data.legal_basis) ? data.legal_basis :
            Array.isArray(currentContext.legal_basis) ? currentContext.legal_basis : [],
          ì·¨ë“ì„¸_legal_basis: rates.ì·¨ë“ì„¸_legal_basis,
          ì§€ë°©êµìœ¡ì„¸_legal_basis: rates.ì§€ë°©êµìœ¡ì„¸_legal_basis,
          ë†íŠ¹ì„¸_legal_basis: rates.ë†íŠ¹ì„¸_legal_basis
        };

        // ì¤‘ë³µ ì²´í¬ë¥¼ ìœ„í•œ í‚¤ ìƒì„±
        const rowKey = `${newRow.ë‚©ì„¸ì}_${newRow.ì·¨ë“ì›ì¸}_${newRow.ê±°ë˜ìœ í˜•}_${newRow.ë¬¼ê±´}_${newRow.ì§€ì—­}_${newRow.ê°€ê²©ëŒ€}_${newRow.ë©´ì }`;

        console.log('ìƒˆë¡œìš´ í–‰ ìƒì„±:', newRow); // ë””ë²„ê¹… ë¡œê·¸

        // ì¤‘ë³µì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì¶”ê°€
        if (!addedRows.has(rowKey)) {
          addedRows.add(rowKey);
          rows.push(newRow);
          console.log('í–‰ ì¶”ê°€ë¨:', rowKey); // ë””ë²„ê¹… ë¡œê·¸
        } else {
          console.log('ì¤‘ë³µìœ¼ë¡œ ì œì™¸ë¨:', rowKey); // ë””ë²„ê¹… ë¡œê·¸
        }
        // return ì œê±° - forEach ë£¨í”„ë¥¼ ê³„ì† ì§„í–‰í•´ì•¼ í•¨
      }

      // í•˜ìœ„ êµ¬ì¡°ê°€ ìˆìœ¼ë©´ ê³„ì† íŒŒì‹±
      if (data.content && Array.isArray(data.content)) {
        data.content.forEach((detail: any) => {
          parseDataRecursively(detail, currentContext, depth + 1);
        });
      }
    };

    // ì„ íƒëœ ì¼€ì´ìŠ¤ì˜ ì„¹ì…˜ë“¤ íŒŒì‹±
    selectedCase.section.forEach((section: any) => {
      const êµ¬ë¶„ = selectedCase.case;
      const originalFileLegalBasis = section.originalLegalBasis || [];
      const centralLegalBasis = section.centralLegalBasis || [];

      // console.log('ğŸ”µ ì„¹ì…˜ íŒŒì‹± ì‹œì‘:', section.title);

      if (section.content && Array.isArray(section.content)) {
        section.content.forEach((subsection: any) => {
          // console.log('  ğŸŸ¢ subsection:', subsection.title);
          // ë°ì´í„° êµ¬ì¡°ì—ì„œ ì •ë³´ ì¶”ì¶œ
          let ë‚©ì„¸ì = section.title || '';
          let ì·¨ë“ì›ì¸ = subsection.title || '';
          let ê±°ë˜ìœ í˜• = '';
          let ë¬¼ê±´ = '';
          let ì§€ì—­ = '';  // ì§€ì—­ ì •ë³´ëŠ” ë” ê¹Šì€ ë ˆë²¨ì—ì„œ ì¶”ì¶œ
          let ì£¼íƒìˆ˜ = '';  // ì£¼íƒìˆ˜ ì •ë³´ë„ ë” ê¹Šì€ ë ˆë²¨ì—ì„œ ì¶”ì¶œ

          // ê±°ë˜ìœ í˜• ì¶”ì¶œ: subsectionì˜ contentì—ì„œ ê±°ë˜ìœ í˜• ì°¾ê¸°
          if (subsection.content && Array.isArray(subsection.content)) {
            // subsection.contentì˜ ì²« ë²ˆì§¸ í•­ëª©ì´ ê±°ë˜ìœ í˜• (ë§¤ë§¤, êµí™˜, ì¦ì—¬ ë“±)
            const ê±°ë˜ìœ í˜•í•­ëª© = subsection.content[0];
            if (ê±°ë˜ìœ í˜•í•­ëª© && ê±°ë˜ìœ í˜•í•­ëª©.title) {
              ê±°ë˜ìœ í˜• = ê±°ë˜ìœ í˜•í•­ëª©.title;
            }
          }

          // ì·¨ë“ì›ì¸ì—ì„œ ê±°ë˜ìœ í˜• ì¶”ì¶œ
          if (ì·¨ë“ì›ì¸ === 'ìœ ìƒ') {
            ì·¨ë“ì›ì¸ = 'ìœ ìƒ';
          } else if (ì·¨ë“ì›ì¸ === 'ë¬´ìƒ') {
            ì·¨ë“ì›ì¸ = 'ë¬´ìƒ';
          } else if (ì·¨ë“ì›ì¸ === 'ì›ì‹œ') {
            ì·¨ë“ì›ì¸ = 'ì›ì‹œ';
          } else if (ì·¨ë“ì›ì¸ === 'ì˜ì œ') {
            ì·¨ë“ì›ì¸ = 'ì˜ì œ';
          }

          // case ì´ë¦„ì—ì„œ ë¬¼ê±´ ì¢…ë¥˜ ì¶”ì¶œ
          if (êµ¬ë¶„.includes('ì£¼íƒ')) {
            ë¬¼ê±´ = 'ì£¼íƒ';
          } else if (êµ¬ë¶„.includes('ë†ì§€ì™¸')) {
            ë¬¼ê±´ = 'ë†ì§€ì™¸';
          } else if (êµ¬ë¶„.includes('ë†ì§€')) {
            ë¬¼ê±´ = 'ë†ì§€';
          } else if (êµ¬ë¶„.includes('ê³¨í”„ì¥')) {
            ë¬¼ê±´ = 'ê³¨í”„ì¥';
          } else if (êµ¬ë¶„.includes('ê³ ê¸‰ì˜¤ë½ì¥')) {
            ë¬¼ê±´ = 'ê³ ê¸‰ì˜¤ë½ì¥';
          }

          // subsectionì´ ê±°ë˜ìœ í˜• ë ˆë²¨ì¸ì§€ í™•ì¸í•˜ê³  ì²˜ë¦¬
          if (subsection.content && Array.isArray(subsection.content)) {
            subsection.content.forEach((ê±°ë˜ìœ í˜•section: any) => {
              // console.log('ê±°ë˜ìœ í˜•section.title:', ê±°ë˜ìœ í˜•section.title); // ë””ë²„ê¹… ë¡œê·¸
              if (ê±°ë˜ìœ í˜•section.title && (ê±°ë˜ìœ í˜•section.title === 'ë§¤ë§¤' || ê±°ë˜ìœ í˜•section.title === 'êµí™˜' ||
                ê±°ë˜ìœ í˜•section.title === 'ì¦ì—¬' || ê±°ë˜ìœ í˜•section.title === 'ìƒì†' || ê±°ë˜ìœ í˜•section.title === 'ì‹ ì¶•' || ê±°ë˜ìœ í˜•section.title === 'ê³¼ì ì£¼ì£¼')) {
                // console.log('ê±°ë˜ìœ í˜• ê°ì§€ë¨:', ê±°ë˜ìœ í˜•section.title); // ë””ë²„ê¹… ë¡œê·¸

                ê±°ë˜ìœ í˜• = ê±°ë˜ìœ í˜•section.title;

                // ê±°ë˜ìœ í˜• í•˜ìœ„ì—ì„œ ë¬¼ê±´, ì§€ì—­, ì£¼íƒìˆ˜ ì •ë³´ ì°¾ê¸°
                if (ê±°ë˜ìœ í˜•section.content && Array.isArray(ê±°ë˜ìœ í˜•section.content)) {
                  ê±°ë˜ìœ í˜•section.content.forEach((ë¬¼ê±´section: any) => {
                    // console.log('ë¬¼ê±´section.title:', ë¬¼ê±´section.title); // ë””ë²„ê¹… ë¡œê·¸
                    let ë¬¼ê±´_description = '';

                    // ë¬¼ê±´ ì¢…ë¥˜ ì‹ë³„ (ì£¼íƒìˆ˜ë¥¼ ë¬¼ê±´ìœ¼ë¡œ ì„¤ì •)
                    if (ë¬¼ê±´section.title) {
                      ë¬¼ê±´_description = ë¬¼ê±´section.description || '';

                      if (ë¬¼ê±´section.title.includes('ì£¼íƒ')) {
                        ë¬¼ê±´ = ë¬¼ê±´section.title; // "1ì£¼íƒ", "2ì£¼íƒ" ë“±ì„ ë¬¼ê±´ìœ¼ë¡œ ì„¤ì •
                        ì£¼íƒìˆ˜ = ''; // ì£¼íƒìˆ˜ëŠ” ë³„ë„ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
                      } else if (ë¬¼ê±´section.title.includes('ë†ì§€ì™¸')) {
                        ë¬¼ê±´ = 'ë†ì§€ì™¸';
                        ì£¼íƒìˆ˜ = '';
                      } else if (ë¬¼ê±´section.title.includes('ë†ì§€')) {
                        ë¬¼ê±´ = 'ë†ì§€';
                        ì£¼íƒìˆ˜ = '';
                      } else if (ë¬¼ê±´section.title.includes('ê³¨í”„ì¥')) {
                        ë¬¼ê±´ = 'ê³¨í”„ì¥';
                        ì£¼íƒìˆ˜ = '';
                      } else if (ë¬¼ê±´section.title.includes('ê³ ê¸‰')) {
                        ë¬¼ê±´ = 'ê³ ê¸‰ì£¼íƒ';
                        ì£¼íƒìˆ˜ = '';
                      } else if (ë¬¼ê±´section.title.includes('ë¬¼ê±´ êµ¬ë¶„ ì—†ìŒ')) {
                        ë¬¼ê±´ = '';
                        ì£¼íƒìˆ˜ = '';
                      } else {
                        ë¬¼ê±´ = ë¬¼ê±´section.title; // ê¸°ë³¸ì ìœ¼ë¡œ titleì„ ë¬¼ê±´ìœ¼ë¡œ ì‚¬ìš©
                        ì£¼íƒìˆ˜ = '';
                      }
                    }

                    // ë¬¼ê±´ í•˜ìœ„ì—ì„œ ì§€ì—­ ì •ë³´ ì°¾ê¸°
                    if (ë¬¼ê±´section.content && Array.isArray(ë¬¼ê±´section.content)) {
                      // console.log(`${ê±°ë˜ìœ í˜•} â†’ ${ë¬¼ê±´} í•˜ìœ„ ì§€ì—­ ê°œìˆ˜:`, ë¬¼ê±´section.content.length); // ë””ë²„ê¹… ë¡œê·¸
                      // console.log(`${ê±°ë˜ìœ í˜•} â†’ ${ë¬¼ê±´} í•˜ìœ„ ì§€ì—­ ëª©ë¡:`, ë¬¼ê±´section.content.map((item: any) => item.title)); // ì¶”ê°€ ë””ë²„ê¹…
                      ë¬¼ê±´section.content.forEach((ì§€ì—­section: any, index: number) => {
                        // ê° ì§€ì—­sectionë§ˆë‹¤ ë³„ë„ì˜ ì§€ì—­ ë³€ìˆ˜ ìƒì„±
                        let í˜„ì¬ì§€ì—­ = '';

                        if (ì§€ì—­section.title) {
                          // console.log(`${ê±°ë˜ìœ í˜•} â†’ ${ë¬¼ê±´} â†’ ì§€ì—­[${index}]:`, ì§€ì—­section.title); // ë””ë²„ê¹… ë¡œê·¸
                          // "ë¹„ì¡°ì •ëŒ€ìƒì§€ì—­"ì— "ì¡°ì •ëŒ€ìƒì§€ì—­"ì´ í¬í•¨ë˜ë¯€ë¡œ ìˆœì„œ ì¤‘ìš”!
                          if (ì§€ì—­section.title.includes('ë¹„ì¡°ì •ëŒ€ìƒì§€ì—­')) {
                            í˜„ì¬ì§€ì—­ = 'ë¹„ì¡°ì •ëŒ€ìƒì§€ì—­';
                            // console.log('âœ… ì„¤ì •ëœ ì§€ì—­: ë¹„ì¡°ì •ëŒ€ìƒì§€ì—­'); // ë””ë²„ê¹… ë¡œê·¸
                          } else if (ì§€ì—­section.title.includes('ì¡°ì •ëŒ€ìƒì§€ì—­')) {
                            í˜„ì¬ì§€ì—­ = 'ì¡°ì •ëŒ€ìƒì§€ì—­';
                            // console.log('âœ… ì„¤ì •ëœ ì§€ì—­: ì¡°ì •ëŒ€ìƒì§€ì—­'); // ë””ë²„ê¹… ë¡œê·¸
                          } else if (ì§€ì—­section.title.includes('ì§€ì—­ êµ¬ë¶„ ì—†ìŒ')) {
                            í˜„ì¬ì§€ì—­ = '';
                            // console.log('âœ… ì„¤ì •ëœ ì§€ì—­: ì§€ì—­ êµ¬ë¶„ ì—†ìŒ'); // ë””ë²„ê¹… ë¡œê·¸
                          } else {
                            // ë‹¤ë¥¸ ì§€ì—­ ì •ë³´ê°€ ìˆë‹¤ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                            í˜„ì¬ì§€ì—­ = ì§€ì—­section.title;
                            console.log('ì„¤ì •ëœ ì§€ì—­: ê¸°íƒ€ -', í˜„ì¬ì§€ì—­); // ë””ë²„ê¹… ë¡œê·¸
                          }
                        }

                        console.log(`ğŸ”¥ ìµœì¢…ì»¨í…ìŠ¤íŠ¸ ìƒì„± - ì§€ì—­: ${í˜„ì¬ì§€ì—­}, ë¬¼ê±´: ${ë¬¼ê±´}`); // ìµœì¢… ì»¨í…ìŠ¤íŠ¸ í™•ì¸
                        const ìµœì¢…ì»¨í…ìŠ¤íŠ¸ = {
                          ë‚©ì„¸ì: ë‚©ì„¸ì,
                          ì·¨ë“ì›ì¸: ì·¨ë“ì›ì¸,
                          ê±°ë˜ìœ í˜•: ê±°ë˜ìœ í˜•,
                          ë¬¼ê±´: ë¬¼ê±´,
                          ë¬¼ê±´_description: ë¬¼ê±´_description,
                          ì§€ì—­: í˜„ì¬ì§€ì—­,  // í˜„ì¬ì§€ì—­ ë³€ìˆ˜ ì‚¬ìš©
                          ì£¼íƒìˆ˜: ì£¼íƒìˆ˜,
                          legal_basis: Array.isArray(ì§€ì—­section.legal_basis) ? ì§€ì—­section.legal_basis :
                            Array.isArray(ë¬¼ê±´section.legal_basis) ? ë¬¼ê±´section.legal_basis :
                              Array.isArray(ê±°ë˜ìœ í˜•section.legal_basis) ? ê±°ë˜ìœ í˜•section.legal_basis :
                                Array.isArray(subsection.legal_basis) ? subsection.legal_basis :
                                  Array.isArray(section.legal_basis) ? section.legal_basis :
                                    originalFileLegalBasis,
                          originalLegalBasis: originalFileLegalBasis,
                          centralLegalBasis: centralLegalBasis
                        };

                        // í•­ìƒ ì¬ê·€ íŒŒì‹± ì‚¬ìš© (ê°€ê²©ëŒ€, ë©´ì  ë“±ì˜ í•˜ìœ„ êµ¬ì¡° ì²˜ë¦¬)
                        parseDataRecursively(ì§€ì—­section, ìµœì¢…ì»¨í…ìŠ¤íŠ¸, 1);
                      });
                    }
                  });
                }
              }
            });
          } else {
            // subsectionì— ë°”ë¡œ ì„¸ìœ¨ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸ (backward compatibility)
            if (Array.isArray(subsection.content) && subsection.content.some((d: any) => d.title === 'ì·¨ë“ì„¸')) {
              const rates = extractTaxRates(subsection.content, originalFileLegalBasis, centralLegalBasis);
              const newRow = {
                ë‚©ì„¸ì: ë‚©ì„¸ì,
                ì·¨ë“ì›ì¸: ì·¨ë“ì›ì¸,
                ê±°ë˜ìœ í˜•: ê±°ë˜ìœ í˜•,
                ë¬¼ê±´: subsection.title, // subsection.titleì„ ë¬¼ê±´ìœ¼ë¡œ ì‚¬ìš©
                ì§€ì—­: '',
                ì£¼íƒìˆ˜: '',
                ê°€ê²©ëŒ€: '',
                ë©´ì : '',
                ì·¨ë“ì„¸: rates.ì·¨ë“ì„¸,
                ì§€ë°©êµìœ¡ì„¸: rates.ì§€ë°©êµìœ¡ì„¸,
                ë†íŠ¹ì„¸: rates.ë†íŠ¹ì„¸,
                í•©ê³„: rates.í•©ê³„,
                ë¹„ê³ : subsection.description || '',
                legal_basis: Array.isArray(subsection.legal_basis) ? subsection.legal_basis :
                  Array.isArray(section.legal_basis) ? section.legal_basis :
                    originalFileLegalBasis,
                ì·¨ë“ì„¸_legal_basis: rates.ì·¨ë“ì„¸_legal_basis,
                ì§€ë°©êµìœ¡ì„¸_legal_basis: rates.ì§€ë°©êµìœ¡ì„¸_legal_basis,
                ë†íŠ¹ì„¸_legal_basis: rates.ë†íŠ¹ì„¸_legal_basis
              };

              // ì¤‘ë³µ ì²´í¬ë¥¼ ìœ„í•œ í‚¤ ìƒì„±
              const rowKey = `${newRow.ë‚©ì„¸ì}_${newRow.ì·¨ë“ì›ì¸}_${newRow.ê±°ë˜ìœ í˜•}_${newRow.ë¬¼ê±´}_${newRow.ì§€ì—­}_${newRow.ê°€ê²©ëŒ€}_${newRow.ë©´ì }`;

              // ì¤‘ë³µì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì¶”ê°€
              if (!addedRows.has(rowKey)) {
                addedRows.add(rowKey);
                rows.push(newRow);
              }
            }
          }
        });
      }
    });

    // ë©´ì ë³„ ê·¸ë£¹í•‘
    const groupedRows = rows.reduce((acc: any[], row) => {
      const groupKey = `${row.ë‚©ì„¸ì}_${row.ì·¨ë“ì›ì¸}_${row.ê±°ë˜ìœ í˜•}_${row.ë¬¼ê±´}_${row.ì§€ì—­}_${row.ì£¼íƒìˆ˜}_${row.ê°€ê²©ëŒ€}`;
      let existingGroup = acc.find(group => group.groupKey === groupKey);

      if (!existingGroup) {
        existingGroup = {
          groupKey,
          ë‚©ì„¸ì: row.ë‚©ì„¸ì,
          ì·¨ë“ì›ì¸: row.ì·¨ë“ì›ì¸,
          ê±°ë˜ìœ í˜•: row.ê±°ë˜ìœ í˜•,
          ë¬¼ê±´: row.ë¬¼ê±´,
          ë¬¼ê±´_description: row.ë¬¼ê±´_description,
          ì§€ì—­: row.ì§€ì—­,
          ì£¼íƒìˆ˜: row.ì£¼íƒìˆ˜,
          ê°€ê²©ëŒ€: row.ê°€ê²©ëŒ€,
          ë¹„ê³ : row.ë¹„ê³ ,
          legal_basis: Array.isArray(row.legal_basis) && row.legal_basis.length > 0 ? row.legal_basis : [],
          subRows: []
        };
        acc.push(existingGroup);
      }

      existingGroup.subRows.push({
        ë©´ì : row.ë©´ì ,
        ì·¨ë“ì„¸: row.ì·¨ë“ì„¸,
        ì§€ë°©êµìœ¡ì„¸: row.ì§€ë°©êµìœ¡ì„¸,
        ë†íŠ¹ì„¸: row.ë†íŠ¹ì„¸,
        í•©ê³„: row.í•©ê³„,
        ì·¨ë“ì„¸_legal_basis: row.ì·¨ë“ì„¸_legal_basis,
        ì§€ë°©êµìœ¡ì„¸_legal_basis: row.ì§€ë°©êµìœ¡ì„¸_legal_basis,
        ë†íŠ¹ì„¸_legal_basis: row.ë†íŠ¹ì„¸_legal_basis
      });

      return acc;
    }, []);

    return groupedRows;
  }, [selectedCase]);

  // í•„í„°ë§ëœ ë°ì´í„°
  const filteredData: TaxRateRow[] = useMemo(() => {
    if (!selectedCase) return [];

    // console.log('ì „ì²´ tableData:', tableData); // ì „ì²´ ë°ì´í„° í™•ì¸
    // console.log('ì§€ì—­ë³„ ë°ì´í„° ê°œìˆ˜:', tableData.filter(item => item.ì§€ì—­ === 'ì¡°ì •ëŒ€ìƒì§€ì—­').length, 'ì¡°ì •ëŒ€ìƒì§€ì—­');
    // console.log('ì§€ì—­ë³„ ë°ì´í„° ê°œìˆ˜:', tableData.filter(item => item.ì§€ì—­ === 'ë¹„ì¡°ì •ëŒ€ìƒì§€ì—­').length, 'ë¹„ì¡°ì •ëŒ€ìƒì§€ì—­');

    if (!filters.ë‚©ì„¸ì && !filters.ì·¨ë“ì›ì¸ && !filters.ê±°ë˜ìœ í˜• && !filters.ë¬¼ê±´ && !filters.ì§€ì—­êµ¬ë¶„ && !filters.ì£¼íƒìˆ˜) {
      return tableData;
    }

    return tableData.filter(group => {
      let matches = true;

      if (filters.ë‚©ì„¸ì && !group.ë‚©ì„¸ì.includes(filters.ë‚©ì„¸ì)) {
        matches = false;
      }

      if (filters.ì·¨ë“ì›ì¸ && !group.ì·¨ë“ì›ì¸.includes(filters.ì·¨ë“ì›ì¸)) {
        matches = false;
      }

      if (filters.ê±°ë˜ìœ í˜• && !group.ê±°ë˜ìœ í˜•.includes(filters.ê±°ë˜ìœ í˜•)) {
        matches = false;
      }

      if (filters.ë¬¼ê±´) {
        if (filters.ë¬¼ê±´ === 'ë†ì§€') {
          // "ë†ì§€" ì •í™•íˆ ì¼ì¹˜ (ë†ì§€ì™¸ ì œì™¸)
          if (!group.ë¬¼ê±´.includes('ë†ì§€') || group.ë¬¼ê±´.includes('ë†ì§€ì™¸')) {
            matches = false;
          }
        } else if (filters.ë¬¼ê±´ === 'ë†ì§€ì™¸') {
          // "ë†ì§€ì™¸" í¬í•¨
          if (!group.ë¬¼ê±´.includes('ë†ì§€ì™¸')) {
            matches = false;
          }
        } else if (filters.ë¬¼ê±´ === 'í† ì§€ê±´ë¬¼') {
          if (!group.ë¬¼ê±´.includes('í† ì§€ê±´ë¬¼')) matches = false;
        } else if (filters.ë¬¼ê±´ === 'ì£¼íƒ') {
          // ì£¼íƒ ê´€ë ¨ í•„í„°ë§ (1ì£¼íƒ, 2ì£¼íƒ ë“± í¬í•¨)
          if (!group.ë¬¼ê±´.includes('ì£¼íƒ')) matches = false;
        } else if (!group.ë¬¼ê±´.includes(filters.ë¬¼ê±´)) {
          matches = false;
        }
      }

      if (filters.ì§€ì—­êµ¬ë¶„ && (group.ë¬¼ê±´.includes('ì£¼íƒ') || filters.ë¬¼ê±´ === 'ì£¼íƒ')) {
        if (filters.ì§€ì—­êµ¬ë¶„ === 'ì¡°ì •' && group.ì§€ì—­ !== 'ì¡°ì •ëŒ€ìƒì§€ì—­') matches = false;
        if (filters.ì§€ì—­êµ¬ë¶„ === 'ë¹„ì¡°ì •' && group.ì§€ì—­ !== 'ë¹„ì¡°ì •ëŒ€ìƒì§€ì—­') matches = false;
      }

      if (filters.ì£¼íƒìˆ˜ && (group.ë¬¼ê±´.includes('ì£¼íƒ') || filters.ë¬¼ê±´ === 'ì£¼íƒ')) {
        if (filters.ì£¼íƒìˆ˜ === '1ì£¼íƒ' && !group.ë¬¼ê±´.includes('1ì£¼íƒ')) matches = false;
        if (filters.ì£¼íƒìˆ˜ === '2ì£¼íƒ' && !group.ë¬¼ê±´.includes('2ì£¼íƒ')) matches = false;
        if (filters.ì£¼íƒìˆ˜ === '3ì£¼íƒ' && !group.ë¬¼ê±´.includes('3ì£¼íƒ')) matches = false;
        if (filters.ì£¼íƒìˆ˜ === '4ì£¼íƒ ì´ìƒ' && !group.ë¬¼ê±´.includes('4ì£¼íƒ')) matches = false;
      }

      return matches;
    });
  }, [tableData, filters, selectedCase]);

  // ì»¨í…ì¸  ë Œë”ë§ í•¨ìˆ˜ (AcquisitionRequirements ìŠ¤íƒ€ì¼ ì°¸ê³ )
  const renderContent = (items: any[], level: number = 0) => {
    if (!items || !Array.isArray(items)) return null;

    return (
      <div className="space-y-3">
        {items.map((item, index) => (
          <div key={index} className="bg-gray-50 rounded-lg">
            <div className="p-4">
              <h4 className="text-base font-medium text-gray-900">{item.title}</h4>
              {item.description && (
                <div
                  className="text-sm text-gray-600 mt-1"
                  dangerouslySetInnerHTML={{ __html: item.description.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') }}
                />
              )}

              {item.content && Array.isArray(item.content) && (
                <div className="mt-3">
                  {renderContent(item.content, level + 1)}
                </div>
              )}
            </div>
          </div>
        ))}
      </div>
    );
  };

  if (isLoading) return <LoadingSpinner />;

  if (error) {
    toast.error('ì·¨ë“ì„¸ ì„¸ìœ¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    return (
      <div className="flex flex-col items-center justify-center min-h-96 text-center">
        <div className="text-red-500 mb-4">
          <svg className="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <h2 className="text-xl font-semibold text-gray-900 mb-2">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</h2>
        <p className="text-gray-600 mb-4">ì·¨ë“ì„¸ ì„¸ìœ¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        <button
          onClick={() => window.location.reload()}
          className="btn-primary"
        >
          ë‹¤ì‹œ ì‹œë„
        </button>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {!selectedCase ? (
        // ì¼€ì´ìŠ¤ ëª©ë¡ í‘œì‹œ (AcquisitionRequirements ìŠ¤íƒ€ì¼)
        <>
          {/* í—¤ë” */}
          <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div className="flex items-center">
              <FiBookOpen className="h-8 w-8 text-blue-600 mr-3" />
              <div className="flex-1">
                <h1 className="text-2xl font-bold text-gray-900">ì·¨ë“ì„¸ ì„¸ìœ¨</h1>
                <p className="text-gray-600 mt-1">ì·¨ë“ì„¸ ì„¸ìœ¨ì— ëŒ€í•œ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
              </div>
            </div>
          </div>

          {/* ì¼€ì´ìŠ¤ ì„ íƒ ì¹´ë“œ */}
          <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h2 className="text-lg font-semibold text-gray-900 mb-4">ì¼€ì´ìŠ¤ ì„ íƒ</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {casesList.map((caseData, index) => (
                <button
                  key={index}
                  onClick={() => handleCaseSelect(caseData)}
                  className="p-4 rounded-lg border-2 transition-all hover:shadow-md border-gray-200 hover:border-gray-300 bg-white hover:bg-gray-50"
                >
                  <div className="flex items-start">
                    <FiFileText className="h-6 w-6 mr-3 flex-shrink-0 text-gray-400" />
                    <div className="text-left">
                      <h3 className="font-medium text-gray-900">
                        {caseData.case}
                      </h3>
                      <p className="text-sm mt-1 line-clamp-2 text-gray-600">
                        {caseData.section.length}ê°œ ì„¹ì…˜
                      </p>
                    </div>
                  </div>
                </button>
              ))}
            </div>
          </div>

          {/* ì£¼ì˜ì‚¬í•­ */}
          <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div className="p-4 bg-yellow-50 rounded-lg">
              <p className="text-sm text-yellow-800">
                <strong>ì£¼ì˜:</strong> ì‹¤ì œ ì„¸ìœ¨ ì ìš© ì‹œì—ëŠ” ê´€ë ¨ ë²•ë ¹ê³¼ ì§€ì—­ë³„ ì¡°ë¡€ë¥¼ ë°˜ë“œì‹œ í™•ì¸í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
                íŠ¹ë¡€ë‚˜ ê°ë©´ ì ìš© ì—¬ë¶€ì— ë”°ë¼ ì‹¤ì œ ë¶€ë‹´ì„¸ì•¡ì´ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </p>
            </div>
          </div>
        </>
      ) : (
        // ì„ íƒëœ ì¼€ì´ìŠ¤ì˜ ì„¸ìœ¨ í‘œì‹œ
        <>
          {/* Back ë²„íŠ¼ê³¼ í—¤ë” */}
          <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-3">
            <div className="flex items-center justify-between">
              <button
                onClick={handleBackToList}
                className="flex items-center px-4 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors"
              >
                <FiArrowLeft className="h-4 w-4 mr-2" />
                ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
              </button>
            </div>
          </div>

          {/* ì„ íƒëœ ì¼€ì´ìŠ¤ í—¤ë” */}
          <div className="bg-blue-50 rounded-lg shadow-sm border border-blue-200 p-4">
            <div className="flex items-center">
              <FiFileText className="h-8 w-8 text-blue-600 mr-3" />
              <div className="flex-1">
                <h1 className="text-2xl font-bold text-blue-900">{selectedCase.case}</h1>
                <p className="text-gray-700 mt-2">
                  {selectedCase.section.length}ê°œ ì„¹ì…˜ì˜ ì„¸ìœ¨ ì •ë³´
                </p>
              </div>
            </div>
          </div>

          {/* í•„í„° ì„¹ì…˜ */}
          <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div className="space-y-4">
              {/* ë‚©ì„¸ì êµ¬ë¶„ */}
              <div>
                <div className="flex flex-wrap gap-2">
                  {FILTER_OPTIONS.ë‚©ì„¸ì.map((option) => (
                    <button
                      key={option}
                      onClick={() => updateFilter('ë‚©ì„¸ì', option)}
                      className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${filters.ë‚©ì„¸ì === option
                        ? 'bg-blue-600 text-white shadow-md'
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                        }`}
                    >
                      {option}
                    </button>
                  ))}
                </div>
              </div>

              {/* ì·¨ë“ì›ì¸ */}
              <div>
                <div className="flex flex-wrap gap-2">
                  {FILTER_OPTIONS.ì·¨ë“ì›ì¸.map((option) => (
                    <button
                      key={option}
                      onClick={() => updateFilter('ì·¨ë“ì›ì¸', option)}
                      className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${filters.ì·¨ë“ì›ì¸ === option
                        ? 'bg-red-600 text-white shadow-md'
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                        }`}
                    >
                      {option}
                    </button>
                  ))}
                </div>
              </div>

              {/* ê±°ë˜ ìœ í˜• */}
              <div>
                <div className="flex flex-wrap gap-2">
                  {FILTER_OPTIONS.ê±°ë˜ìœ í˜•.map((option) => (
                    <button
                      key={option}
                      onClick={() => updateFilter('ê±°ë˜ìœ í˜•', option)}
                      className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${filters.ê±°ë˜ìœ í˜• === option
                        ? 'bg-purple-600 text-white shadow-md'
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                        }`}
                    >
                      {option}
                    </button>
                  ))}
                </div>
              </div>

              {/* ë¬¼ê±´ ì¢…ë¥˜ */}
              <div>

                <div className="flex flex-wrap gap-2">
                  {FILTER_OPTIONS.ë¬¼ê±´.map((option) => (
                    <button
                      key={option}
                      onClick={() => updateFilter('ë¬¼ê±´', option)}
                      className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${filters.ë¬¼ê±´ === option
                        ? 'bg-green-600 text-white shadow-md'
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                        }`}
                    >
                      {option}
                    </button>
                  ))}
                </div>
              </div>

              {/* ì£¼íƒ ì„ íƒ ì‹œ ì¶”ê°€ í•„í„° */}
              {filters.ë¬¼ê±´ === 'ì£¼íƒ' && (
                <div className="space-y-4 pl-4 border-l-4 border-green-200">
                  {/* ì£¼íƒìˆ˜ êµ¬ë¶„ */}
                  <div>
                    <h4 className="text-xs font-medium text-gray-600 mb-1">ì£¼íƒìˆ˜</h4>
                    <div className="flex flex-wrap gap-2">
                      {FILTER_OPTIONS.ì£¼íƒìˆ˜.map((option) => (
                        <button
                          key={option}
                          onClick={() => updateFilter('ì£¼íƒìˆ˜', option)}
                          className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${filters.ì£¼íƒìˆ˜ === option
                            ? 'bg-orange-600 text-white shadow-md'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                            }`}
                        >
                          {option}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* ì§€ì—­ êµ¬ë¶„ */}
                  <div>
                    <h4 className="text-xs font-medium text-gray-600 mb-1">ì§€ì—­êµ¬ë¶„</h4>
                    <div className="flex flex-wrap gap-2">
                      {FILTER_OPTIONS.ì§€ì—­êµ¬ë¶„.map((option) => (
                        <button
                          key={option.value}
                          onClick={() => updateFilter('ì§€ì—­êµ¬ë¶„', option.value)}
                          className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${filters.ì§€ì—­êµ¬ë¶„ === option.value
                            ? 'bg-yellow-600 text-white shadow-md'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                            }`}
                        >
                          {option.label}
                        </button>
                      ))}
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* í•„í„° ì´ˆê¸°í™” ë° í˜„ì¬ í•„í„° í˜„í™© */}
            <div className="flex items-center gap-4 mb-2 mt-2">
              <button
                onClick={resetFilters}
                className="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors"
              >
                <FiRefreshCw className="w-4 h-4" />
                í•„í„° ì´ˆê¸°í™”
              </button>

              {/* í™œì„± í•„í„° í‘œì‹œ */}
              {(filters.ë‚©ì„¸ì || filters.ì·¨ë“ì›ì¸ || filters.ê±°ë˜ìœ í˜• || filters.ë¬¼ê±´ || filters.ì§€ì—­êµ¬ë¶„ || filters.ì£¼íƒìˆ˜) && (
                <div className="p-3 bg-blue-50 rounded-md">
                  <div className="flex flex-wrap gap-2">
                    {filters.ë‚©ì„¸ì && (
                      <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        {filters.ë‚©ì„¸ì}
                      </span>
                    )}
                    {filters.ì·¨ë“ì›ì¸ && (
                      <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                        {filters.ì·¨ë“ì›ì¸}
                      </span>
                    )}
                    {filters.ê±°ë˜ìœ í˜• && (
                      <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                        {filters.ê±°ë˜ìœ í˜•}
                      </span>
                    )}
                    {filters.ë¬¼ê±´ && (
                      <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        {filters.ë¬¼ê±´}
                      </span>
                    )}
                    {filters.ì§€ì—­êµ¬ë¶„ && (
                      <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                        {filters.ì§€ì—­êµ¬ë¶„ === 'ì¡°ì •' ? 'ì¡°ì •ëŒ€ìƒì§€ì—­' : 'ë¹„ì¡°ì •ëŒ€ìƒì§€ì—­'}
                      </span>
                    )}
                    {filters.ì£¼íƒìˆ˜ && (
                      <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                        {filters.ì£¼íƒìˆ˜}
                      </span>
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* ì„¸ìœ¨ í‘œ */}
          <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200 table-fixed" style={{ tableLayout: 'fixed' }}>
                <colgroup>
                  <col style={{ width: '8%' }} />
                  <col style={{ width: '8%' }} />
                  <col style={{ width: '8%' }} />
                  <col style={{ width: '8%' }} />
                  <col style={{ width: '10%' }} />
                  <col style={{ width: '12%' }} />
                  <col style={{ width: '10%' }} />
                  <col style={{ width: '10%' }} />
                  <col style={{ width: '10%' }} />
                  <col style={{ width: '10%' }} />
                  <col style={{ width: '10%' }} />
                </colgroup>
                <thead className="bg-blue-200">
                  <tr>
                    <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë‚©ì„¸ì</th>
                    <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì·¨ë“ì›ì¸</th>
                    <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ê±°ë˜ìœ í˜•</th>
                    <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë¬¼ê±´</th>
                    <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì§€ì—­</th>
                    <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ê°€ê²©</th>
                    <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë©´ì </th>
                    <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider font-bold">í•©ê³„</th>
                    <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì·¨ë“ì„¸</th>
                    <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì§€ë°©êµìœ¡ì„¸</th>
                    <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë†íŠ¹ì„¸</th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {filteredData.map((group, groupIndex) => {
                    // console.log(`ê·¸ë£¹ ${groupIndex} ì§€ì—­ ê°’:`, group.ì§€ì—­); // ì§€ì—­ ê°’ í™•ì¸
                    const isEven = groupIndex % 2 === 0;
                    const groupBgColor = isEven ? 'bg-white' : 'bg-gray-50';
                    const groupCellBgColor = isEven ? 'bg-gray-100' : 'bg-gray-200';

                    return (group.subRows || []).map((subRow: any, subIndex: number) => (
                      <tr key={`${groupIndex}-${subIndex}`} className={groupBgColor}>
                        {subIndex === 0 && (
                          <>
                            <td rowSpan={group.subRows?.length || 1} className={`px-2 py-4 text-sm font-medium text-gray-900 border-r border-gray-200 ${groupCellBgColor} break-words`}>{group.ë‚©ì„¸ì}</td>
                            <td rowSpan={group.subRows?.length || 1} className={`px-2 py-4 text-sm text-gray-900 border-r border-gray-200 ${groupCellBgColor} break-words`}>{group.ì·¨ë“ì›ì¸}</td>
                            <td rowSpan={group.subRows?.length || 1} className={`px-2 py-4 text-sm text-gray-900 border-r border-gray-200 ${groupCellBgColor} break-words`}>{group.ê±°ë˜ìœ í˜•}</td>
                            <td rowSpan={group.subRows?.length || 1} className={`px-2 py-4 text-sm text-gray-900 border-r border-gray-200 ${groupCellBgColor} break-words`}>
                              {group.ë¬¼ê±´_description ? (
                                <Tooltip content={[group.ë¬¼ê±´_description]}>
                                  {group.ë¬¼ê±´}
                                </Tooltip>
                              ) : (
                                group.ë¬¼ê±´
                              )}
                            </td>
                            <td rowSpan={group.subRows?.length || 1} className={`px-2 py-4 text-sm text-gray-900 border-r border-gray-200 ${groupCellBgColor}`}>
                              {group.ì§€ì—­ && (
                                <span className={`inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium ${group.ì§€ì—­ === 'ì¡°ì •ëŒ€ìƒì§€ì—­'
                                  ? 'bg-red-200 text-red-900'
                                  : 'bg-green-200 text-green-900'
                                  }`}>
                                  {group.ì§€ì—­}
                                </span>
                              )}
                            </td>
                            {/* <td rowSpan={group.subRows?.length || 1} className={`px-2 py-4 text-sm text-gray-900 border-r border-gray-200 ${groupCellBgColor} break-words`}>{group.ì£¼íƒìˆ˜}</td> */}
                            <td rowSpan={group.subRows?.length || 1} className={`px-2 py-4 text-sm text-gray-900 border-r border-gray-200 ${groupCellBgColor} break-words`}>{group.ê°€ê²©ëŒ€}</td>
                          </>
                        )}
                        <td className={`px-2 py-4 text-sm text-gray-900 font-medium ${groupCellBgColor} break-words`}>
                          {subRow.ë©´ì  || ((group.subRows?.length || 1) === 1 ? '-' : '')}
                        </td>
                        <td className={`px-2 py-4 text-sm font-bold text-purple-600 border border-purple-200 ${groupCellBgColor} relative break-words`}>
                          <div className="flex items-center justify-between">
                            <span>{subRow.í•©ê³„}</span>
                          </div>
                        </td>
                        <td className={`px-2 py-4 text-sm font-semibold text-blue-600 ${groupCellBgColor} break-words`}>
                          <Tooltip content={subRow.ì·¨ë“ì„¸_legal_basis || []}>
                            {subRow.ì·¨ë“ì„¸}
                          </Tooltip>
                        </td>
                        <td className={`px-2 py-4 text-sm font-semibold text-green-600 ${groupCellBgColor} break-words`}>
                          <Tooltip content={subRow.ì§€ë°©êµìœ¡ì„¸_legal_basis || []}>
                            {subRow.ì§€ë°©êµìœ¡ì„¸}
                          </Tooltip>
                        </td>
                        <td className={`px-2 py-4 text-sm font-semibold text-orange-600 ${groupCellBgColor} break-words`}>
                          <Tooltip content={subRow.ë†íŠ¹ì„¸_legal_basis || []}>
                            {subRow.ë†íŠ¹ì„¸}
                          </Tooltip>
                        </td>
                      </tr>
                    ))
                  })}
                </tbody>
              </table>
            </div>
          </div>

          {/* ë²”ë¡€ */}
          <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 className="text-lg font-semibold text-gray-900 mb-4">ë²”ë¡€ ë° ì£¼ì˜ì‚¬í•­</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <h4 className="font-medium text-gray-900 mb-2">ì§€ì—­ êµ¬ë¶„</h4>
                <div className="space-y-2">
                  <div className="flex items-center">
                    <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 mr-2">
                      ì¡°ì •ëŒ€ìƒì§€ì—­
                    </span>
                    <span className="text-sm text-gray-600">ê°•ë‚¨êµ¬, ì„œì´ˆêµ¬, ì†¡íŒŒêµ¬, ìš©ì‚°êµ¬</span>
                  </div>
                  <div className="flex items-center">
                    <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 mr-2">
                      ì¡°ì •ëŒ€ìƒì§€ì—­ ì™¸
                    </span>
                    <span className="text-sm text-gray-600">ì¼ë°˜ ì§€ì—­</span>
                  </div>
                </div>
              </div>
              <div>
                <h4 className="font-medium text-gray-900 mb-2">ì„¸ìœ¨ ìƒ‰ìƒ</h4>
                <div className="space-y-2">
                  <div className="flex items-center">
                    <div className="w-4 h-4 bg-blue-600 rounded mr-2"></div>
                    <span className="text-sm text-gray-600">ì·¨ë“ì„¸</span>
                  </div>
                  <div className="flex items-center">
                    <div className="w-4 h-4 bg-green-600 rounded mr-2"></div>
                    <span className="text-sm text-gray-600">ì§€ë°©êµìœ¡ì„¸</span>
                  </div>
                  <div className="flex items-center">
                    <div className="w-4 h-4 bg-orange-600 rounded mr-2"></div>
                    <span className="text-sm text-gray-600">ë†ì–´ì´ŒíŠ¹ë³„ì„¸</span>
                  </div>
                  <div className="flex items-center">
                    <div className="w-4 h-4 bg-purple-600 rounded mr-2"></div>
                    <span className="text-sm text-gray-600 font-bold">í•©ê³„ì„¸ì•¡</span>
                  </div>
                </div>
              </div>
            </div>
            <div className="mt-4 p-4 bg-yellow-50 rounded-lg">
              <p className="text-sm text-yellow-800">
                <strong>ì£¼ì˜:</strong> ì‹¤ì œ ì„¸ìœ¨ ì ìš© ì‹œì—ëŠ” ê´€ë ¨ ë²•ë ¹ê³¼ ì§€ì—­ë³„ ì¡°ë¡€ë¥¼ ë°˜ë“œì‹œ í™•ì¸í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
                íŠ¹ë¡€ë‚˜ ê°ë©´ ì ìš© ì—¬ë¶€ì— ë”°ë¼ ì‹¤ì œ ë¶€ë‹´ì„¸ì•¡ì´ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </p>
            </div>
          </div>
        </>
      )}
    </div>
  );
};

export default AcquisitionRates;